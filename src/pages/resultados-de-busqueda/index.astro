---
import { lucia } from "@/auth";
import ResultsPage from "@/components/preact/Results/ResultsPage";
import type {
  ResultLocation,
  Results,
} from "@/interfaces/selects.form.interfaces";
import Layout from "@/layouts/Layout.astro";
import { getAllSelects, getLocations } from "@/services/get-selects-form";
import { eq } from "astro:db";
import { db } from "astro:db";
import { Session } from "astro:db";
import type { User } from "lucia";

const userAuthCookie =  lucia.readSessionCookie( 
Astro.request.headers.get("Cookie") ?? ""
)  
const userSession = await db.select().from(Session).where(eq(Session.id, userAuthCookie as string))
type UserWithoutID = Omit<{
  id:string;
  userId:string;
  expiresAt:number;
}, '_id'>;
const user: UserWithoutID = userSession[0];

/* Fetch selects */
const selects = (await getAllSelects()) as Results;
const locations = (await getLocations()) as ResultLocation;

---

<Layout title="Resultados de Busqueda" description="Busca tu propiedad">
  <article class="bg-secondary-bg-msb h-full">
    <div class="container mx-auto font-gotham">
      <ResultsPage session={user  || null} selects={selects} locations={locations} client:only transition:persist  />
    </div>
  </article>
</Layout>
